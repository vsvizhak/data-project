- hosts: all
  become: true

  tasks:
    - name: "[01/06] Ensure source_db directories exist"
      file:
        path: "{{ project_dir }}/source_db/{{ item }}"
        state: directory
        owner: "{{ new_user }}"
        group: "{{ new_user }}"
        mode: "0755"
      loop:
        - migration
        - proc
        - conf
        - seeder

    - name: "[02/06] Upload migration SQL files"
      copy:
        src: "{{ item }}"
        dest: "{{ project_dir }}/source_db/migration/"
        owner: "{{ new_user }}"
        group: "{{ new_user }}"
        mode: "0644"
      with_fileglob:
        - "{{ playbook_dir }}/../app/source_db/migration/*.sql"

    - name: "[03/06] Upload proc SQL files"
      copy:
        src: "{{ item }}"
        dest: "{{ project_dir }}/source_db/proc/"
        owner: "{{ new_user }}"
        group: "{{ new_user }}"
        mode: "0644"
      with_fileglob:
        - "{{ playbook_dir }}/../app/source_db/proc/*.sql"

    - name: "[04/06] Upload flyway.conf"
      copy:
        src: "{{ playbook_dir }}/../app/source_db/conf/flyway.conf"
        dest: "{{ project_dir }}/source_db/conf/flyway.conf"
        owner: "{{ new_user }}"
        group: "{{ new_user }}"
        mode: "0644"

    - name: "[05/06] Upload seeder files"
      copy:
        src: "{{ item }}"
        dest: "{{ project_dir }}/source_db/seeder/"
        owner: "{{ new_user }}"
        group: "{{ new_user }}"
        mode: "0644"
      with_fileglob:
        - "{{ playbook_dir }}/../app/source_db/seeder/*"

    - name: "[06/06] Make entrypoint.sh executable"
      file:
        path: "{{ project_dir }}/source_db/seeder/entrypoint.sh"
        mode: "0755"